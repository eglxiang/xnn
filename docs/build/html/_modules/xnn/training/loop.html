<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>xnn.training.loop &mdash; xnn 2.2 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="xnn 2.2 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for xnn.training.loop</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">xnn</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">bokeh.plotting</span> <span class="kn">import</span> <span class="n">output_server</span><span class="p">,</span> <span class="n">figure</span><span class="p">,</span> <span class="n">push</span><span class="p">,</span> <span class="n">curdoc</span><span class="p">,</span> <span class="n">cursession</span><span class="p">,</span><span class="n">vplot</span>
<span class="kn">import</span> <span class="nn">time</span>

<div class="viewcode-block" id="Loop"><a class="viewcode-back" href="../../../modules/xnn.training.html#xnn.training.loop.Loop">[docs]</a><span class="k">class</span> <span class="nc">Loop</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An example training loop.  The trainer will learn from learndata, apply metrics to validdata, plot to bokeh server at url if supplied, and save to csv file.</span>

<span class="sd">    :param trainer: The trainer to run</span>
<span class="sd">    :param learndata:  A list of generator functions that yield batches of data from which the trainer will learn</span>
<span class="sd">    :param validdata:  A list of generator functions that yield batches of data to which the metrics will be applied</span>
<span class="sd">    :param metrics:  A list of metrics to apply to the validdata.  Each entry is a tuple, the first element of which is the key in the model.predict output from which the metric should be calculated, the second element of which is the metric, the third element of which is either &#39;max&#39; or &#39;min&#39; to specify which direction is best</span>
<span class="sd">    :param url: A string representing the url where the bokeh server is running (e.g. &#39;http://127.0.0.1:5006&#39;). If None, or if server cannot be connected, no plotting will occur</span>
<span class="sd">    :param savefilenamecsv:  The name of a file into which to write metric results at each epoch.</span>
<span class="sd">    :param weightdict:  Dictionary of Weighters.  Keys in weightdict are keys into which the weight results will be inserted in the data dictionary.  Weights are calculated for every training batch.</span>
<span class="sd">    :param printflag: Whether to print results to stdout after each epoch</span>
<span class="sd">    :param plotmetricmean: Whether to print/save/plot mean of all metrics.  Depending on the metrics, this value might not make sense.</span>
<span class="sd">    :param savemodelnamebase: Base name for saving metrics.  If not None, models will be saved for the best values of each metric as looping procedes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">trainer</span><span class="p">,</span><span class="n">learndata</span><span class="o">=</span><span class="p">[],</span><span class="n">validdata</span><span class="o">=</span><span class="p">[],</span><span class="n">metrics</span><span class="o">=</span><span class="p">[],</span><span class="n">url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">savefilenamecsv</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">weightdict</span><span class="o">=</span><span class="p">{},</span><span class="n">printflag</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">plotmetricmean</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">savemodelnamebase</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="n">trainer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learndata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listify</span><span class="p">(</span><span class="n">learndata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listify</span><span class="p">(</span><span class="n">validdata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metdirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weightdict</span> <span class="o">=</span> <span class="n">weightdict</span>
        <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_plotsession</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_datasources</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_flag</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">savefilenamecsv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">savefilenamecsv</span><span class="o">=</span><span class="n">savefilenamecsv</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">_savecsv_flag</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_savecsv_flag</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">savemodelnamebase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">savemodelnamebase</span> <span class="o">=</span> <span class="n">savemodelnamebase</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_savemodel_flag</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_savemodel_flag</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_flag</span> <span class="o">=</span> <span class="n">printflag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plotmetricmean</span><span class="o">=</span><span class="n">plotmetricmean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bestmetvals</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bestatep</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meandur</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ep</span> <span class="o">=</span> <span class="mi">0</span>
        

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the Loop by calling it with a number of epochs as argument</span>

<span class="sd">    :param niter: number of iterations (epochs) to run</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">niter</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">endep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ep</span><span class="o">+</span><span class="n">niter</span>
        <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ep</span><span class="p">,</span><span class="n">endep</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ep</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c"># training</span>
            <span class="n">trainerrs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ld</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">learndata</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">():</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weight</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                    <span class="n">outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                    <span class="n">trainerrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">trainerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trainerrs</span><span class="p">)</span>

            <span class="c"># validation</span>
            <span class="n">metvals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">vd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">validdata</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">vd</span><span class="p">():</span>
                    <span class="n">outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">metkey</span><span class="p">,</span><span class="n">met</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
                        <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">met</span><span class="p">(</span><span class="n">outs</span><span class="p">[</span><span class="n">metkey</span><span class="p">],</span><span class="n">batch</span><span class="p">))</span>
                <span class="n">metvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
            <span class="n">metvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">metvals</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">dur</span> <span class="o">=</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meandur</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meandur</span> <span class="o">=</span> <span class="n">dur</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meandur</span> <span class="o">=</span> <span class="mf">0.3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">meandur</span> <span class="o">+</span> <span class="mf">0.7</span><span class="o">*</span><span class="n">dur</span>

            <span class="c">#update best values</span>
            <span class="n">isbest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_best</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span><span class="n">trainerr</span><span class="p">,</span><span class="n">metvals</span><span class="p">)</span>

            <span class="c">#print summary to stdout</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_flag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span><span class="n">trainerr</span><span class="p">,</span><span class="n">metvals</span><span class="p">,</span><span class="n">dur</span><span class="p">,</span><span class="n">endep</span><span class="p">)</span>

            <span class="c">#plot</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_flag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_plot</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span><span class="n">trainerr</span><span class="p">,</span><span class="n">metvals</span><span class="p">)</span>

            <span class="c">#save to csv</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_savecsv_flag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_save</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span><span class="n">trainerr</span><span class="p">,</span><span class="n">metvals</span><span class="p">)</span>

            <span class="c">#save model if best for any metrics</span>
            <span class="n">isbest_nontrainerr</span> <span class="o">=</span> <span class="n">isbest</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_savemodel_flag</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">isbest_nontrainerr</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_savemodel</span><span class="p">(</span><span class="n">isbest_nontrainerr</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_flag</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Finished </span><span class="si">%d</span><span class="s"> epochs at </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">niter</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%I:%M:%S %p&#39;</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">batch</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightdict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">batch</span>

    <span class="k">def</span> <span class="nf">_savemodel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">isbest</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plotmetricmean</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">isbest</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">savemodelnamebase</span> <span class="o">+</span> <span class="s">&#39;_metricmean&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">isbest</span> <span class="o">=</span> <span class="n">isbest</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> 
        <span class="k">for</span> <span class="p">(</span><span class="n">mk</span><span class="p">,</span><span class="n">mt</span><span class="p">),</span><span class="n">ib</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span><span class="n">isbest</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ib</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">savemodelnamebase</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">mk</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span><span class="o">+</span> <span class="n">xnn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">metric_names</span><span class="p">[</span><span class="n">mt</span><span class="o">.</span><span class="n">metric</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_update_best</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ep</span><span class="p">,</span><span class="n">trainerr</span><span class="p">,</span><span class="n">metvals</span><span class="p">):</span>
        <span class="n">isbest</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">best</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bestatep</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plotmetricmean</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">trainerr</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">metvals</span><span class="p">)]</span> <span class="o">+</span> <span class="n">metvals</span>
            <span class="n">dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;min&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;min&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metdirs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">trainerr</span><span class="p">]</span><span class="o">+</span><span class="n">metvals</span>
            <span class="n">dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;min&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metdirs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bestmetvals</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bestmetvals</span> <span class="o">=</span> <span class="n">vals</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bestatep</span> <span class="o">=</span> <span class="p">[</span><span class="n">ep</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span>
            <span class="n">isbest</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_bestmetvals</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_bestatep</span><span class="p">,</span><span class="n">dirs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="s">&#39;max&#39;</span><span class="p">:</span>
                    <span class="n">bestcheck</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">b</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bestcheck</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">b</span>
                <span class="k">if</span> <span class="n">bestcheck</span><span class="p">:</span>
                    <span class="n">isbest</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">best</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">bestatep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">isbest</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                    <span class="n">best</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">bestatep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bestmetvals</span> <span class="o">=</span> <span class="n">best</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bestatep</span> <span class="o">=</span> <span class="n">bestatep</span>
        <span class="k">return</span> <span class="n">isbest</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ep</span><span class="p">,</span><span class="n">trainerr</span><span class="p">,</span><span class="n">metvals</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datasources</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_figures</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span><span class="n">trainerr</span><span class="p">,</span><span class="n">metvals</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plotmetricmean</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">trainerr</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">metvals</span><span class="p">)]</span> <span class="o">+</span> <span class="n">metvals</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">trainerr</span><span class="p">]</span> <span class="o">+</span> <span class="n">metvals</span>
        <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">ds</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_datasources</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_datasource</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">ep</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_datasource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ds</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">ep</span><span class="p">):</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">cursession</span><span class="p">()</span><span class="o">.</span><span class="n">store_objects</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_figures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ep</span><span class="p">,</span><span class="n">trainerr</span><span class="p">,</span><span class="n">metvals</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datasources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">figures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Total Training Cost&#39;</span><span class="p">,</span><span class="n">x_axis_label</span><span class="o">=</span><span class="s">&#39;Epoch&#39;</span><span class="p">,</span><span class="n">y_axis_label</span><span class="o">=</span><span class="s">&#39;Cost&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">([</span><span class="n">ep</span><span class="p">],[</span><span class="n">trainerr</span><span class="p">],</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;plot&#39;</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;plot&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datasources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plotmetricmean</span><span class="p">:</span>
            <span class="n">figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Metric Mean&#39;</span><span class="p">,</span><span class="n">x_axis_label</span><span class="o">=</span><span class="s">&#39;Epoch&#39;</span><span class="p">,</span><span class="n">y_axis_label</span><span class="o">=</span><span class="s">&#39;Mean&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">([</span><span class="n">ep</span><span class="p">],[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">metvals</span><span class="p">)],</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;plot&#39;</span><span class="p">)</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;plot&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_source</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_datasources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
            <span class="n">figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mv</span><span class="p">,(</span><span class="n">mk</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">metvals</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">xnn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">metric_names</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">metric</span><span class="p">]</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">mk</span><span class="p">,</span><span class="n">x_axis_label</span><span class="o">=</span><span class="s">&#39;Epoch&#39;</span><span class="p">,</span><span class="n">y_axis_label</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">([</span><span class="n">ep</span><span class="p">],[</span><span class="n">mv</span><span class="p">],</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;plot&#39;</span><span class="p">)</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;plot&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_source</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_datasources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
            <span class="n">figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">allfigs</span> <span class="o">=</span> <span class="n">vplot</span><span class="p">(</span><span class="o">*</span><span class="n">figures</span><span class="p">)</span>
        <span class="n">push</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ep</span><span class="p">,</span><span class="n">trainerr</span><span class="p">,</span><span class="n">metvals</span><span class="p">,</span><span class="n">dur</span><span class="p">,</span><span class="n">totalep</span><span class="p">):</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;{0:45} {1:20}:   {2:0.4f} (best {3:0.4f} at epoch {4:g})&#39;</span>
        <span class="k">print</span> <span class="s">&#39;==========&#39;</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Epoch </span><span class="si">%d</span><span class="s"> / </span><span class="si">%d</span><span class="s"> -- </span><span class="si">%0.2f</span><span class="s"> seconds&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span><span class="n">totalep</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">dur</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Expected Finish: </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timedone</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span><span class="n">totalep</span><span class="p">)))</span>
        <span class="k">print</span> <span class="s">&#39;----------&#39;</span>
        <span class="k">print</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;Training total cost&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">trainerr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_bestmetvals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_bestatep</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">print</span> <span class="s">&#39;----------&#39;</span>
        <span class="n">beststartid</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plotmetricmean</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;Overall Mean&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">metvals</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">_bestmetvals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_bestatep</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">print</span> <span class="s">&#39;----------&#39;</span>
            <span class="n">beststartid</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">mv</span><span class="p">,(</span><span class="n">mk</span><span class="p">,</span><span class="n">m</span><span class="p">),</span><span class="n">bv</span><span class="p">,</span><span class="n">be</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">metvals</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_bestmetvals</span><span class="p">[</span><span class="n">beststartid</span><span class="p">:],</span><span class="bp">self</span><span class="o">.</span><span class="n">_bestatep</span><span class="p">[</span><span class="n">beststartid</span><span class="p">:]):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">xnn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">metric_names</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">metric</span><span class="p">]</span>
            <span class="k">print</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">mk</span><span class="p">,</span><span class="n">mv</span><span class="p">,</span><span class="n">bv</span><span class="p">,</span><span class="n">be</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">_timedone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ep</span><span class="p">,</span><span class="n">totalep</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">done</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">meandur</span><span class="o">*</span><span class="p">(</span><span class="n">totalep</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">ep</span><span class="p">)</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">done</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%a, %I:%M:%S %p&#39;</span><span class="p">,</span><span class="n">ts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ep</span><span class="p">,</span><span class="n">trainerr</span><span class="p">,</span><span class="n">metvals</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;_headers_written&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers_written</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_header</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers_written</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefilenamecsv</span><span class="p">,</span><span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s">&#39;</span><span class="si">%0.4f</span><span class="s">,&#39;</span><span class="o">%</span><span class="n">trainerr</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plotmetricmean</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s">&#39;</span><span class="si">%0.4f</span><span class="s">,&#39;</span><span class="o">%</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">metvals</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">mv</span> <span class="ow">in</span> <span class="n">metvals</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s">&#39;</span><span class="si">%0.4f</span><span class="s">,&#39;</span><span class="o">%</span><span class="n">mv</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_save_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savefilenamecsv</span><span class="p">,</span><span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Training cost,&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plotmetricmean</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Overall mean,&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">mk</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">xnn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">metric_names</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">metric</span><span class="p">]</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;_&#39;</span><span class="o">+</span><span class="n">mk</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_init_plotsession</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">url</span><span class="p">):</span>
        <span class="n">docname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">output_server</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">curdoc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_address</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/bokeh/doc/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">docid</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">ref</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;plots available at: </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_address</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">True</span>



    <span class="k">def</span> <span class="nf">_listify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">thing</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">thing</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">thing</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Josh Susskind and contributors.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.6</a>
      
    </div>

    

    
  </body>
</html>